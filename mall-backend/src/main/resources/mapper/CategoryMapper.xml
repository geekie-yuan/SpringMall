<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="site.geekie.shop.shoppingmall.mapper.CategoryMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="site.geekie.shop.shoppingmall.entity.Category">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="parent_id" property="parentId"/>
        <result column="level" property="level"/>
        <result column="sort_order" property="sortOrder"/>
        <result column="icon" property="icon"/>
        <result column="status" property="status"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <!-- 基础字段列表 -->
    <sql id="Base_Column_List">
        id, name, parent_id, level, sort_order, icon, status, created_at, updated_at
    </sql>

    <!-- 根据ID查询分类 -->
    <select id="findById" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM category
        WHERE id = #{id}
    </select>

    <!-- 查询所有分类 -->
    <select id="findAll" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM category
        ORDER BY sort_order ASC, created_at ASC
    </select>

    <!-- 根据父分类ID查询子分类 -->
    <select id="findByParentId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM category
        WHERE parent_id = #{parentId}
        ORDER BY sort_order ASC
    </select>

    <!-- 根据层级查询分类 -->
    <select id="findByLevel" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM category
        WHERE level = #{level}
        ORDER BY sort_order ASC
    </select>

    <!-- 根据状态查询分类 -->
    <select id="findByStatus" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM category
        WHERE status = #{status}
        ORDER BY sort_order ASC
    </select>

    <!-- 插入分类 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO category (name, parent_id, level, sort_order, icon, status)
        VALUES (#{name}, #{parentId}, #{level}, #{sortOrder}, #{icon}, #{status})
    </insert>

    <!-- 更新分类 -->
    <update id="updateById">
        UPDATE category
        <set>
            <if test="name != null">name = #{name},</if>
            <if test="parentId != null">parent_id = #{parentId},</if>
            <if test="level != null">level = #{level},</if>
            <if test="sortOrder != null">sort_order = #{sortOrder},</if>
            <if test="icon != null">icon = #{icon},</if>
            <if test="status != null">status = #{status},</if>
            updated_at = CURRENT_TIMESTAMP
        </set>
        WHERE id = #{id}
    </update>

    <!-- 删除分类 -->
    <delete id="deleteById">
        DELETE FROM category WHERE id = #{id}
    </delete>

    <!-- 统计子分类数量 -->
    <select id="countByParentId" resultType="int">
        SELECT COUNT(*) FROM category WHERE parent_id = #{parentId}
    </select>

    <!-- 根据名称和父ID查询分类 -->
    <select id="findByNameAndParentId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM category
        WHERE name = #{name} AND parent_id = #{parentId}
    </select>

</mapper>
